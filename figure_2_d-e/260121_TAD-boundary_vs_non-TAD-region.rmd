---
title: "Figure 2 (D-E): Measurement of boundary distances. Distance distributions of TAD boundary versus matched non-TAD region"
author: "Gianluca Pegoraro and Faisal Almansour"
date: "2026-01-22"
output:
  html_document:
    toc: true
    toc_float: true
    number_sections: true
    df_print: paged
    code_folding: "hide"
    theme: flatly
---
Analysis setup
If you cloned or copied this folder, restore the exact package versions with: `renv::restore()`
```{r load-libraries}
here::i_am("260121_TAD-boundary_vs_non-TAD-region.rmd")

library(tidyverse)
library(here)
library(SpatialTools)
library(fs)
library(reshape2)
library(data.table)
library(ggthemes)
library(ggpointdensity)
library(FSA)
```
Adjust and standarize figures width and height
```{r set-options, include=FALSE, warning=FALSE}
knitr::opts_chunk$set(
  fig.path = "output/",
  fig.width = 7,
  fig.height = 7,
  dev     = "pdf",
  message = FALSE,
  warning = FALSE)
```
Plot text size settings, set the relative size for all the fonts in all the plots. A value of 1 keeps is as it is. Values \> 1 make fonts larger. Value \< 1 make fonts smaller. Play around with it.
```{r set-font-size}
new_size <- 1.5
```

```{r set-theme, include = FALSE}
theme_set(theme_bw())
theme_update(
  axis.text.x  = element_text(angle = -45, hjust = 0, vjust = 0.5, size = rel(new_size)),
  axis.text.y  = element_text(hjust = 0, size = rel(new_size)),
  axis.title   = element_text(size = rel(new_size)),
  legend.text  = element_text(size = rel(new_size)),
  legend.title = element_text(size = rel(new_size)),
  strip.text   = element_text(size = rel(new_size)),
  title        = element_text(size = rel(new_size)))
source(here("helpers", "plot_functions.R"))
```
Image acquisition and analysis conditions
Specify x,y pixel size (microns) and z-step (microns).
```{r set-resolution}
xy_res <- 0.108
z_step <- 0.1
```
Read the metadata
```{r}
metadata_index <- tibble::tibble(
  experiment = c("HFF_EGFR", "HFF_MYC", "HBEC_EGFR", "HBEC_MYC"),
  metadata_path = here::here(c(
    "metadata/hff_egfr_layout.txt",
    "metadata/hff_myc_layout.txt",
    "metadata/hbec_egfr_layout.txt",
    "metadata/hbec_myc_layout.txt")))

read_one_md <- function(exp_label, md_path) {
  readr::read_tsv(md_path, show_col_types = FALSE) %>%
    dplyr::mutate(experiment = exp_label)}

md_tbl <- purrr::map2_dfr(
  metadata_index$experiment,
  metadata_index$metadata_path,
  read_one_md) %>%
  dplyr::filter(!is.na(treat)) %>%
  dplyr::mutate(
    treat = factor(treat),
    treat_conc = factor(treat_conc, levels = sort(unique(treat_conc))),
    row = as.character(row),
    column = as.character(column),
    experiment_key = tolower(experiment))

md_tbl_join <- md_tbl %>%
  dplyr::distinct(experiment_key, row, column, .keep_all = TRUE) %>%
  dplyr::select(experiment_key, row, column, treat, treat_conc)
```
### Plates layout
```{r treat_layout, echo=FALSE}
md_tbl %>%
  dplyr::group_split(experiment) %>%
  purrr::walk(~{
    df <- .x %>%
      dplyr::mutate(
        column = suppressWarnings(as.integer(column)),
        row = dplyr::case_when(
          grepl("^[A-Za-z]+$", row) ~ match(toupper(row), LETTERS),
          TRUE ~ suppressWarnings(as.integer(row))))
    print(plot_plate(df, property = treat, legend = "Treatment", title = as.character(df$experiment[1])))
    invisible(NULL)})
```
Read object-level data
```{r}
data_index <- tibble::tibble(
  experiment = c("HFF_EGFR", "HFF_MYC", "HBEC_EGFR", "HBEC_MYC"),
  data_path  = here::here("data", c("hff_egfr", "hff_myc", "hbec_egfr", "hbec_myc")))
stopifnot(all(fs::dir_exists(data_index$data_path)))
```
Set `glob` patterns for directory searches for cell level data and spot data,resepectively. The spot level data is stored in a single .csv file per well where all the spots in all the channels are stored. The `channel` variable value indicates the channel in which the spot was detected according to this mapping:
-   2: Green (488)
-   3: Red (561)
-   4: Far Red (640)

Read and process the cell-level data. Filter nuclei that are irregularly shaped (`solidity`) and that are too small (`area`).
```{r read-cells}
cell_tbl <- data_index %>%
  dplyr::mutate(cell_csvs = purrr::map(data_path, ~ fs::dir_ls(.x, recurse = TRUE, glob = "*well_nuclei_results/*.csv"))) %>%
  tidyr::unnest(cell_csvs, names_repair = "unique") %>%
  dplyr::rename(file_name = cell_csvs) %>%
  dplyr::mutate(data = purrr::map(file_name, ~ data.table::fread(.x) |> tibble::as_tibble())) %>%
  tidyr::unnest(data) %>%
  dplyr::rename(x = `centroid-0`, y = `centroid-1`) %>%
  dplyr::select(experiment, column, row, field_index, time_point, cell_index, x:solidity) %>%
  dplyr::mutate(
    row = as.character(row),
    column = as.character(column),
    experiment_key = tolower(experiment)) %>%
  dplyr::filter(solidity >= 0.95, area >= 10) %>%
  dplyr::arrange(experiment, column, row, field_index, time_point, cell_index)
```
Read the spot-level CSVs (compact, per-experiment folders)
Convert the x, y and z coordinates to microns (They were originally calculated in pixels) and filter spots that do not belong to any nucleus. These have a `cell_index` value of `0`.
```{r read-spots}
spot_tbl <- data_index %>%
  dplyr::mutate(spot_csvs = purrr::map(data_path, ~ fs::dir_ls(.x, recurse = TRUE, glob = "*well_spots_locations/*.csv"))) %>%
  tidyr::unnest(spot_csvs, names_repair = "unique") %>%
  dplyr::rename(file_name = spot_csvs) %>%
  dplyr::mutate(data = purrr::map(file_name, ~ data.table::fread(.x) |> tibble::as_tibble())) %>%
  tidyr::unnest(data) %>%
  dplyr::rename(spot_index_raw = V1, x = x_location, y = y_location, z = z_location) %>%
  
  dplyr::mutate(
    x_mic = x * xy_res,
    y_mic = y * xy_res,
    z_mic = z * z_step) %>%
  
  dplyr::filter(cell_index != 0) %>%
  dplyr::mutate(
    row = as.character(row),
    column = as.character(column),
    experiment_key = tolower(experiment)) %>%
  dplyr::select(experiment, file_name, column, row, field_index, time_point, cell_index, spot_index_raw, channel, mean_intensity, x, y, z, x_mic, y_mic, z_mic) %>%
  dplyr::arrange(experiment, column, row, field_index, time_point, cell_index, channel) %>%
  dplyr::group_by(experiment, row, column, field_index, time_point, cell_index, channel) %>%
  dplyr::mutate(spot_index = dplyr::row_number()) %>%
  dplyr::ungroup()

spot_tbl <- spot_tbl %>%
  dplyr::mutate(
    experiment_key = tolower(experiment),
    row    = as.character(row),
    column = as.character(column))
```
Use the `spot_tbl` to calculate the number of spots per cell in each color.
```{r calc-n-spots}
cell_n_spots_tbl <- spot_tbl %>%
  dplyr::group_by(experiment_key, row, column, field_index, time_point, cell_index, channel) %>%
  dplyr::summarise(n = dplyr::n(), .groups = "drop") %>%
  tidyr::pivot_wider(
    names_from   = channel,
    names_prefix = "n_spots_channel_",
    values_from  = n,
    values_fill  = 0)%>%
   dplyr::inner_join(md_tbl_join, by = c("experiment_key","row", "column"))

cell_counts <- cell_tbl %>%
  dplyr::left_join(cell_n_spots_tbl,
    by = c("experiment_key","row","column","field_index","time_point","cell_index")) %>%
  dplyr::left_join(md_tbl_join,
    by = c("experiment_key","row","column"))

```
### Red Histograms, 5' probe
```{r n-red-spots-well, echo=F}
cell_n_spots_tbl %>%
  dplyr::group_split(.by = experiment_key) %>%
  purrr::map(~{
    ek <- unique(.x$experiment_key)

    ggplot(.x, aes(
      x = n_spots_channel_3,
      y = after_stat(density),
      fill = treat)) +
      geom_histogram(binwidth = 1) +
      scale_x_continuous(breaks = 0:10) +
      scale_fill_tableau(name = "Treatment") +
      coord_cartesian(xlim = c(-1, 10)) +
      #facet_grid(vars(row), vars(column)) +
      xlab("Number of Red Spots per Cell") +
      ggtitle(paste0(ek))})

```
### Green Histograms, 3' probe
```{r n-green-spots-well, echo=F}
cell_n_spots_tbl %>%
  dplyr::group_split(.by = experiment_key) %>%
  purrr::map(~{
    ek <- unique(.x$experiment_key)

    ggplot(.x, aes(
      x = n_spots_channel_2,
      y = after_stat(density),
      fill = treat)) +
      geom_histogram(binwidth = 1) +
      scale_x_continuous(breaks = 0:10) +
      scale_fill_tableau(name = "Treatment") +
      coord_cartesian(xlim = c(-1, 10)) +
      #facet_grid(vars(row), vars(column)) +
      xlab("Number of Green Spots per Cell") +
      ggtitle(paste0(ek))})
```
### FarRed Histograms, nascent RNA probe
```{r n-farred-spots-well, echo=F}
cell_n_spots_tbl %>%
  dplyr::group_split(.by = experiment_key) %>%
  purrr::map(~{
    ek <- unique(.x$experiment_key)

    ggplot(.x, aes(
      x = n_spots_channel_4,
      y = after_stat(density),
      fill = treat)) +
      geom_histogram(binwidth = 1) +
      scale_x_continuous(breaks = 0:10) +
      scale_fill_tableau(name = "Treatment") +
      coord_cartesian(xlim = c(-1, 10)) +
      #facet_grid(vars(row), vars(column)) +
      xlab("Number of FarRed  Spots per Cell") +
      ggtitle(paste0(ek))})
```
Cell filtering based on spots number
Keep only cells that have 2 spots in the Green channel, 2 spots in the Red channel, and 2 or less spots in the FarRed channel.
```{r}
cell_n_spots_filt_tbl <- cell_n_spots_tbl %>%
  semi_join(cell_tbl, by = c("row", "column", "experiment_key", "field_index",
                             "time_point", "cell_index")) %>%
  filter(n_spots_channel_2 == 2,
         n_spots_channel_3 == 2,
         n_spots_channel_4 <= 2)

glimpse(cell_n_spots_filt_tbl)
```
Filter out spots that do not belong to the correct population of cells obtained in the previous chunk.
```{r}
spot_filt_tbl <- spot_tbl %>% 
  semi_join(cell_n_spots_filt_tbl, 
            by = c("column", "row", "experiment_key", "field_index",
                   "time_point", "cell_index"))%>%
  ungroup() %>%
  as.data.table()
  
glimpse(spot_filt_tbl)
```
2D Distances Calculations
Calculate 2D/2D spot distances for the Green-Red pairs.
```{r calc-spot-dist, results="hide"}
gr_dist_2D <- spot_filt_tbl[channel %in% 2:3, # Only Green and Red spots
                              reshape2::melt(dist2(as.matrix(.SD[channel == 2,
                                                       list(x_mic,y_mic,z_mic)]),
                                         as.matrix(.SD[channel == 3,
                                                       list(x_mic,y_mic,z_mic)])),
                                   value.name = "gr_dist"),
                          by = list(row, 
                                    column,
                                    experiment_key,
                                    field_index, 
                                    time_point, 
                                    cell_index)]

setnames(gr_dist_2D, c("Var1","Var2"), c("g_index","r_index"))

glimpse(gr_dist_2D)
```
Calculate 2D/2D spot distances for the FarRed-Red pairs.
```{r}
fr_dist_2D <- spot_filt_tbl[channel %in% 3:4, # Only Red and Far Red spots
                            reshape2::melt(dist2(as.matrix(.SD[channel == 4,
                                                         list(x_mic,y_mic,z_mic),]), 
                                         as.matrix(.SD[channel == 3,
                                                         list(x_mic,y_mic,z_mic)])),
                               value.name = "fr_dist"),
                          by = list(row, 
                                    column,
                                    experiment_key,
                                    field_index, 
                                    time_point, 
                                    cell_index)]

setnames(fr_dist_2D, c("Var1","Var2"), c("f_index","r_index"))

glimpse(fr_dist_2D)
```
Calculate 2D/2D spot distances for the FarRed-Green pairs.
```{r}
gf_dist_2D <- spot_filt_tbl[channel %in% c(2,4), # Only Green and Far Red spots
                            reshape2::melt(dist2(as.matrix(.SD[channel == 2,
                                                         list(x_mic,y_mic,z_mic),]), 
                                         as.matrix(.SD[channel == 4,
                                                         list(x_mic,y_mic,z_mic)])),
                               value.name = "gf_dist"),
                            by = list(row, 
                                      column,
                                      experiment_key,
                                      field_index, 
                                      time_point, 
                                      cell_index)]

setnames(gf_dist_2D, c("Var1","Var2"), c("g_index","f_index"))

glimpse(gf_dist_2D)
```
Green-Red (3'-5') proximity calculations. **Important: this calculations find the closest Green/Red pairs (by calculating the the minimum distance) on a per Red Spot basis**.
```{r proximityR-G, warning=F}
setkey(gr_dist_2D, row, column, experiment_key, field_index, time_point, cell_index, r_index)

gr_dist_min_2D <- gr_dist_2D[, .SD[which.min(gr_dist),], 
                        by = key(gr_dist_2D)]

glimpse(gr_dist_min_2D)
```
Red-FarRed (5'-nRNA)  proximity calculations. **Important: this calculations find the closest Red/FarRed pairs (by calculating the the minimum distance) on a per Red Spot basis**.
```{r proximityR-F, warning=F}
setkey(fr_dist_2D, row, column, experiment_key, field_index, cell_index, time_point, r_index)

fr_dist_min_2D <- fr_dist_2D[, .SD[which.min(fr_dist),], 
                        by = key(fr_dist_2D)]

glimpse(fr_dist_min_2D)
```
Green-FarRed (3'-nRNA)  proximity calculations. **Important: this calculations find the closest Green/FarRed pairs (by calculating the the minimum distance) on a per Green Spot basis**.
```{r proximityG-F, warning=F}
setkey(gf_dist_2D, row, column, experiment_key, field_index, cell_index, time_point, g_index)

gf_dist_min_2D <- gf_dist_2D[, .SD[which.min(gf_dist),], 
                             by = key(gf_dist_2D)]

glimpse(gf_dist_min_2D)
```
Join GR (3'-5') and FR (nRNA-5') distances tables based on the red spot index (5'). We use `full_join` because we want to keep pairs of Red/Green probes that have no matching FarRed spots, or, in other words, inactive alleles. These are labelled with `NA` for both the `f_index` and for `fr_dist`.
```{r}
gfr_dist_min_2D <- gr_dist_min_2D %>%
  full_join(fr_dist_min_2D, by = c("row", "column", "experiment_key", "field_index", 
                                    "cell_index", "time_point", 
                                    "r_index")) %>%
  inner_join(md_tbl, by = c("row", "column", "experiment_key"))

glimpse(gfr_dist_min_2D)
```
Generate a filtered dataset with only FarRed spots.
```{r}
fr_spot_filt_tbl <- spot_filt_tbl %>%
  filter(channel == 4) %>%
  select(row, column, experiment_key, field_index, time_point,
         cell_index, f_index = spot_index, mean_intensity)

glimpse(fr_spot_filt_tbl)
```

```{r}
gfr_dist_min_2D <- gfr_dist_min_2D %>%
  #left_join(md_tbl, on = c("row", "column")) %>%
  left_join(fr_spot_filt_tbl, by = c("row", "column", "experiment_key", 
                                     "field_index", "time_point",
                                     "cell_index", "f_index"))

glimpse(gfr_dist_min_2D)
```
### Red-FarRed distances Single Allele Density Plots

```{r gfr-fr-dist-density-pooled, echo=FALSE}
gfr_dist_min_2D %>%
  dplyr::group_split(.by = experiment_key) %>%
  purrr::map(~{
    ek <- paste(unique(.x$experiment_key), collapse = ", ")

    ggplot(.x, aes(
      x = fr_dist,
      color = treat,
      fill  = treat)) +
      scale_fill_tableau(name = "Treatment") +
      scale_color_tableau(name = "Treatment") +
      coord_cartesian(xlim = c(0, 20), ylim = c(0, 3)) +
      geom_density(alpha = 0.3) +
      scale_x_continuous(breaks = seq(0, 20, 1)) +
      labs(
        x = "2D Far-Red/Red Minimum Dist. (Microns)",
        y = "Density",
        title = paste0("Far-Red/Red — ", ek))})

```
### Figure 2 (D-E)
```{r figure 2 (D-E), echo=FALSE}
gfr_dist_min_2D %>%
  dplyr::group_split(.by = experiment_key) %>%
  purrr::map(~{
    ek <- paste(unique(.x$experiment_key), collapse = ", ")

    ggplot(.x, aes(
      x = gr_dist,
      color = treat,
      fill  = treat)) +
      scale_fill_tableau(name = "Treatment") +
      scale_color_tableau(name = "Treatment") +
      coord_cartesian(xlim = c(0, 20), ylim = c(0, 3)) +
      geom_density(alpha = 0.3) +
      labs(
        x = "2D Green/Red Minimum Dist. (Microns)",
        y = "Density",
        title = paste0("Green/Red — ", ek))})
```
### Numerical summaries (Mean, SD, Median, IQR)
Summarize **without** taking FarRed Status in account on a per well basis.
```{r well-summaries, results='asis'}
well_2D <- gfr_dist_min_2D %>%
  group_by(row, column, experiment_key, treat, treat_conc) %>%
  summarize(across(c(gr_dist, fr_dist),
                   list(mean = ~ mean(.x, na.rm = T), 
                        median = ~ median(.x, na.rm = T),
                        sd = ~ sd(.x, na.rm = T),
                        iqr = ~ IQR(.x, na.rm = TRUE))))

write_csv(well_2D,
          "output/well_2D.csv")

knitr::kable(well_2D, digits = 2)
```
Summarize **without** taking FarRed Status in account by taking the Mean, SD, Median, and IQR of wells per condition.
```{r pool-summaries}
pool_2D <- well_2D %>%
  group_by(treat, experiment_key, treat_conc) %>%
  summarize(across(c(gr_dist_mean, gr_dist_median, fr_dist_mean, fr_dist_median),
                   list(mean = ~ mean(.x, na.rm = T),
                        sd = ~ sd(.x, na.rm = T),
                        iqr = ~ IQR(.x, na.rm = TRUE))))

write_csv(pool_2D,
          "output/fr_status_pool_2D.csv")

knitr::kable(pool_2D, digits = 2)
```
### Frequency of loops
Classify looping status
Establish that:
-   green-red (3'-5') spots who are equal to or smaller than 2.5 microns in 2D are looped
-   green-red (3'-5') spots who are larger than 2.5 microns in 2D are unlooped
```{r}
gfr_dist_min_2D <- gfr_dist_min_2D %>%
  mutate(cut_off = case_when(
    gr_dist <= 0.25 ~ "looped",
    gr_dist > 0.25 ~ "unlooped"))
```

```{r loop-frequency}
loop <- gfr_dist_min_2D %>%
  group_by(treat, experiment_key, cut_off) %>%
  summarize(n = n()) %>%
  mutate(freq = n/sum(n))

write_csv(loop,
          "output/loop_freq.csv")

knitr::kable(loop, digits = 2)
```
### Statistical tests
Run Mann Whitney Wilcoxon Parametric Test; Compare the DNA/RNA FISH and MS2 groups
```{r statistical-test-cont-vs-treat-DRB-2D, echo=F}
gfr_dist_min_2D %>%
  group_by(experiment_key) %>%
  summarise(n = n(),
            pval = {
              group1 <- gr_dist[treat == unique(treat)[1]]
              group2 <- gr_dist[treat == unique(treat)[2]]
              wilcox.test(group1, group2, paired = FALSE)$p.value
            })

# Check the groups
group1 <- gfr_dist_min_2D$gr_dist[gfr_dist_min_2D$treat == unique(gfr_dist_min_2D$treat)[1]]
group2 <- gfr_dist_min_2D$gr_dist[gfr_dist_min_2D$treat == unique(gfr_dist_min_2D$treat)[2]]

# Summary statistics
summary(group1)
summary(group2)

# Effect size (e.g., median difference)
median_diff <- median(group1) - median(group2)
median_diff

# Run the Wilcoxon test
wilcox_result <- wilcox.test(group1, group2, paired = FALSE)
pval <- wilcox_result$p.value
pval
```
Document the information about the analysis session
```{r sessionInfo, include=TRUE, echo=TRUE, results="markup"}
sessionInfo()
```