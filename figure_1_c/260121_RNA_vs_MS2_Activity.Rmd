---
title: "Figure 1 C: Quantification of MYC nascent RNA signals using DNA/RNA HiFISH in fixed HBEC
cells or a MS2-tagged MYC reporter in living HBEC cells"
author: "Faisal Almansour"
date: "2026-01-21"
output:
  html_document:
    toc: true
    toc_float: true
    number_sections: true
    df_print: paged
    code_folding: "hide"
    theme: flatly
---
Analysis setup
If you cloned or copied this folder, restore the exact package versions with: `renv::restore()`
```{r load-libraries}
here::i_am("260121_RNA_vs_MS2_activity.Rmd")

library(tidyverse)
library(data.table)
library(here)
library(fs)
library(ggthemes)
library(conflicted)
conflicts_prefer(dplyr::filter, dplyr::lag, dplyr::select)

set.seed(1234)
```
Adjust and standarize figures width and height
```{r set-options, include=FALSE, warning=FALSE}
knitr::opts_chunk$set(
  fig.path   = "output/",
  fig.width  = 15,
  fig.height = 7,
  message    = FALSE,
  warning    = FALSE)
```
Plot text size settings, set the relative size for all the fonts in all the plots. A value of 1 keeps is as it is. Values \> 1 make fonts larger. Value \< 1 make fonts smaller. Play around with it.
```{r set-font-size}
new_size <- 1.5
```

```{r set-theme, include = FALSE}
theme_set(theme_bw())
theme_update(
  axis.text.x  = element_text(angle = -45, hjust = 0, vjust = 0.5, size = rel(new_size)),
  axis.text.y  = element_text(hjust = 0, size = rel(new_size)),
  axis.title   = element_text(size = rel(new_size)),
  legend.text  = element_text(size = rel(new_size)),
  legend.title = element_text(size = rel(new_size)),
  strip.text   = element_text(size = rel(new_size)),
  title        = element_text(size = rel(new_size)))
source(here("helpers", "plot_functions.R"))
```
Image acquisition and analysis conditions
Specify x,y pixel size (microns) and z-step (microns).
```{r set-resolution}
xy_res <- 0.108
z_step <- 0.1
```
Read the metadata
```{r}
metadata_index <- tibble::tibble(
  experiment = c("Exp1_RNA", "Exp2_RNA", "Exp1_MS2", "Exp2_MS2"),
  metadata_path = here::here(c(
    "metadata/exp1_rna_layout.txt",
    "metadata/exp2_rna_layout.txt",
    "metadata/exp1_ms2_layout.txt",
    "metadata/exp2_ms2_layout.txt")))

read_one_md <- function(exp_label, md_path) {
  readr::read_tsv(md_path, show_col_types = FALSE) %>%
    dplyr::mutate(experiment = exp_label)}

md_tbl <- purrr::map2_dfr(
  metadata_index$experiment,
  metadata_index$metadata_path,
  read_one_md) %>%
  dplyr::filter(!is.na(treat)) %>%
  dplyr::mutate(
    treat = factor(treat),
    treat_conc = factor(treat_conc, levels = sort(unique(treat_conc))),
    row = as.character(row),
    column = as.character(column),
    experiment_key = tolower(experiment))

md_tbl_join <- md_tbl %>%
  dplyr::distinct(experiment_key, row, column, .keep_all = TRUE) %>%
  dplyr::select(experiment_key, row, column, treat, treat_conc)
```
### Plates layout
```{r treat_layout, echo=FALSE}
md_tbl %>%
  dplyr::group_split(experiment) %>%
  purrr::walk(~{
    df <- .x %>%
      dplyr::mutate(
        column = suppressWarnings(as.integer(column)),
        row = dplyr::case_when(
          grepl("^[A-Za-z]+$", row) ~ match(toupper(row), LETTERS),
          TRUE ~ suppressWarnings(as.integer(row))))
    print(plot_plate(df, property = treat, legend = "Treatment", title = as.character(df$experiment[1])))
    invisible(NULL)})
```
Read object-level data
```{r}
data_index <- tibble::tibble(
  experiment = c("Exp1_ms2", "Exp2_ms2", "Exp1_rna", "Exp2_rna"),
  data_path  = here::here("data", c("exp1_ms2", "exp2_ms2", "exp1_rna", "exp2_rna")))
stopifnot(all(fs::dir_exists(data_index$data_path)))
```
Set `glob` patterns for directory searches for cell level data and spot data,resepectively. The spot level data is stored in a single .csv file per well where all the spots in all the channels are stored.
Read and process the cell-level data. Filter nuclei that are irregularly shaped (`solidity`) and that are too small (`area`).
```{r read-cells}
cell_tbl <- data_index %>%
  dplyr::mutate(cell_csvs = purrr::map(data_path, ~ fs::dir_ls(.x, recurse = TRUE, glob = "*well_nuclei_results/*.csv"))) %>%
  tidyr::unnest(cell_csvs, names_repair = "unique") %>%
  dplyr::rename(file_name = cell_csvs) %>%
  dplyr::mutate(data = purrr::map(file_name, ~ data.table::fread(.x) |> tibble::as_tibble())) %>%
  tidyr::unnest(data) %>%
  dplyr::rename(x = `centroid-0`, y = `centroid-1`) %>%
  dplyr::select(experiment, column, row, field_index, time_point, cell_index, x:solidity) %>%
  dplyr::mutate(
    row = as.character(row),
    column = as.character(column),
    experiment_key = tolower(experiment)) %>%
  dplyr::filter(solidity >= 0.95, area >= 10) %>%
  dplyr::arrange(experiment, column, row, field_index, time_point, cell_index)
```
Read the spot-level CSVs (compact, per-experiment folders)
Convert the x, y and z coordinates to microns (They were originally calculated in pixels) and filter spots that do not belong to any nucleus. These have a `cell_index` value of `0`.
```{r read-spots}
spot_tbl <- data_index %>%
  dplyr::mutate(spot_csvs = purrr::map(data_path, ~ fs::dir_ls(.x, recurse = TRUE, glob = "*well_spots_locations/*.csv"))) %>%
  tidyr::unnest(spot_csvs, names_repair = "unique") %>%
  dplyr::rename(file_name = spot_csvs) %>%
  dplyr::mutate(data = purrr::map(file_name, ~ data.table::fread(.x) |> tibble::as_tibble())) %>%
  tidyr::unnest(data) %>%
  dplyr::rename(spot_index_raw = V1, x = x_location, y = y_location, z = z_location) %>%
  
  dplyr::mutate(
    x_mic = x * xy_res,
    y_mic = y * xy_res,
    z_mic = z * z_step) %>%
  
  dplyr::filter(cell_index != 0) %>%
  dplyr::mutate(
    row = as.character(row),
    column = as.character(column),
    experiment_key = tolower(experiment)) %>%
  dplyr::select(experiment, file_name, column, row, field_index, time_point, cell_index, spot_index_raw, channel, mean_intensity, x, y, z, x_mic, y_mic, z_mic) %>%
  dplyr::arrange(experiment, column, row, field_index, time_point, cell_index, channel) %>%
  dplyr::group_by(experiment, row, column, field_index, time_point, cell_index, channel) %>%
  dplyr::mutate(spot_index = dplyr::row_number()) %>%
  dplyr::ungroup()

spot_tbl <- spot_tbl %>%
  dplyr::mutate(
    experiment_key = tolower(experiment),
    row    = as.character(row),
    column = as.character(column))
```
Use the `spot_tbl` to calculate the number of spots per cell in each color.
```{r calc-n-spots}
cell_n_spots_tbl <- spot_tbl %>%
  dplyr::group_by(experiment_key, row, column, field_index, time_point, cell_index, channel) %>%
  dplyr::summarise(n = dplyr::n(), .groups = "drop") %>%
  tidyr::pivot_wider(
    names_from   = channel,
    names_prefix = "n_spots_channel_",
    values_from  = n,
    values_fill  = 0)

cell_counts <- cell_tbl %>%
  dplyr::left_join(cell_n_spots_tbl,
    by = c("experiment_key","row","column","field_index","time_point","cell_index")) %>%
  dplyr::left_join(md_tbl_join,
    by = c("experiment_key","row","column")) %>%
  dplyr::filter(!is.na(treat))

```
### Histograms, MYC nascent RNA signals using DNA/RNA HiFISH in fixed HBEC
cells or a MS2-tagged MYC reporter in living HBEC cells
```{r spots-well, echo=F}
channel_map <- tibble::tibble(experiment = unique(cell_counts$experiment)) %>%
  dplyr::mutate(channel_of_interest = dplyr::if_else(grepl("_ms2$", experiment, TRUE), 1L, 4L))

cell_sel <- cell_counts %>%
  dplyr::left_join(channel_map, by = "experiment") %>%
  dplyr::mutate(
    n_spots = dplyr::if_else(channel_of_interest == 1L, dplyr::coalesce(n_spots_channel_1, 0L), dplyr::coalesce(n_spots_channel_4, 0L)))

ggplot2::ggplot(cell_sel, ggplot2::aes(x = n_spots, y = ggplot2::after_stat(density), fill = treat)) +
  ggplot2::geom_histogram(binwidth = 1, boundary = -0.5, closed = "right") +
  ggplot2::scale_x_continuous(breaks = 0:8) +
  ggthemes::scale_fill_tableau(name = "Condition") +
  ggplot2::coord_cartesian(xlim = c(-0.5, 8.5)) +
  ggplot2::labs(x = "Number of spots per cell", y = "Density", title = "") +
  ggplot2::facet_wrap(~ experiment, ncol = 2)
```
Combine Exp1 + Exp2 and classify 0/1/2/≥3
```{r n-ms2-spots-well-combine, echo=F}
cell_buckets_rep <- cell_sel %>%
  dplyr::mutate(
    assay_type = dplyr::if_else(grepl("_ms2$", experiment, TRUE), "MS2", "RNA"),
    ms2_status = dplyr::case_when(
      is.na(n_spots) ~ "0",
      n_spots >= 3L  ~ ">=3",
      n_spots %in% c(0L,1L,2L) ~ as.character(n_spots),
      TRUE ~ ">=3"),
    ms2_status = factor(ms2_status, levels = c("0","1","2",">=3")))

freq_by_rep <- cell_buckets_rep %>%
  dplyr::group_by(assay_type, experiment, ms2_status) %>%
  dplyr::summarise(cells = dplyr::n(), .groups = "drop_last") %>%
  dplyr::mutate(freq = cells / sum(cells)) %>%
  dplyr::ungroup()

summary_se <- freq_by_rep %>%
  dplyr::group_by(assay_type, ms2_status) %>%
  dplyr::summarise(
    mean_freq = mean(freq, na.rm = TRUE),
    se_freq   = if (dplyr::n() > 1) stats::sd(freq, na.rm = TRUE) / sqrt(dplyr::n()) else NA_real_,
    .groups   = "drop")
```
Summary statistics and Wilcoxon tests
```{r}
summary_stats <- freq_by_rep %>%
  dplyr::group_by(ms2_status, assay_type) %>%
  dplyr::summarise(
    n_reps     = dplyr::n(),
    mean_freq  = mean(freq, na.rm = TRUE),
    median_freq= median(freq, na.rm = TRUE),
    sd_freq    = stats::sd(freq, na.rm = TRUE),
    .groups    = "drop")

mw_results <- freq_by_rep %>%
  dplyr::filter(assay_type %in% c("RNA","MS2")) %>%
  dplyr::group_by(ms2_status) %>%
  dplyr::summarise(
    p_value = tryCatch(stats::wilcox.test(freq[assay_type=="RNA"], freq[assay_type=="MS2"])$p.value, error = function(e) NA_real_),
    .groups = "drop") %>%
  dplyr::mutate(
    significance = dplyr::case_when(
      is.na(p_value)  ~ "NA",
      p_value < 0.001 ~ "***",
      p_value < 0.01  ~ "**",
      p_value < 0.05  ~ "*",
      TRUE            ~ "ns"))
```
### Numerical summaries (Mean, SD, Median, IQR) and statistical tests
```{r}
replicate_table <- freq_by_rep %>%
  dplyr::group_by(assay_type, experiment) %>%
  dplyr::mutate(total_cells_per_exp = sum(cells)) %>%
  dplyr::ungroup() %>%
  dplyr::arrange(assay_type, experiment, ms2_status)

knitr::kable(
  replicate_table,
  caption = "Replicate-level counts and frequencies per assay and category",
  digits = c(0,0,0,3))

summary_stats <- freq_by_rep %>%
  dplyr::group_by(ms2_status, assay_type) %>%
  dplyr::summarise(
    n_reps      = dplyr::n(),
    mean_freq   = mean(freq, na.rm = TRUE),
    median_freq = median(freq, na.rm = TRUE),
    sd_freq     = stats::sd(freq, na.rm = TRUE),
    se_freq     = dplyr::if_else(n_reps > 1, sd_freq / sqrt(n_reps), NA_real_),
    .groups     = "drop")

knitr::kable(
  summary_stats,
  caption = "Summary statistics per assay and category (across replicates)",
  digits = c(0,0,0,3,3,3))

mw_results <- freq_by_rep %>%
  dplyr::mutate(
    ms2_status = factor(ms2_status, levels = c("0","1","2",">=3")),
    assay_type = factor(assay_type, levels = c("RNA","MS2"))) %>%
  dplyr::group_by(ms2_status) %>%
  dplyr::summarise(
    n_RNA  = sum(assay_type == "RNA"),
    n_MS2  = sum(assay_type == "MS2"),
    p_value = tryCatch(
      stats::wilcox.test(
        x = freq[assay_type == "RNA"],
        y = freq[assay_type == "MS2"],
        exact = FALSE
      )$p.value,
      error = function(e) NA_real_),
    .groups = "drop") %>%
  dplyr::mutate(
    p_adj = p.adjust(p_value, method = "BH"),
    significance = dplyr::case_when(
      is.na(p_value)  ~ "NA",
      p_value < 0.001 ~ "***",
      p_value < 0.01  ~ "**",
      p_value < 0.05  ~ "*",
      TRUE            ~ "ns")) %>%
  dplyr::arrange(ms2_status)

knitr::kable(
  mw_results,
  caption = "Wilcoxon (RNA vs MS2) for each category (0, 1, 2, ≥3) using per-experiment frequencies",
  digits = c(0,0,3,3),
  align = "lrrr")

summary_with_p <- summary_stats %>%
  dplyr::left_join(mw_results, by = "ms2_status") %>%
  dplyr::arrange(ms2_status, assay_type)

knitr::kable(
  summary_with_p,
  caption = "Summary statistics + Wilcoxon results (RNA vs MS2) per category",
  digits = c(n_reps=0, mean_freq=3, median_freq=3, sd_freq=3, se_freq=3, n_RNA=0, n_MS2=0, p_value=3, p_adj=3))

overall_cells_by_category <- freq_by_rep %>%
  dplyr::group_by(assay_type, ms2_status) %>%
  dplyr::summarise(total_cells = sum(cells), .groups = "drop") %>%
  dplyr::arrange(assay_type, ms2_status)

knitr::kable(
  overall_cells_by_category,
  caption = "Total cells by assay and category (pooled Exp1+Exp2)",
  digits = 0)

overall_cells_by_assay <- freq_by_rep %>%
  dplyr::group_by(assay_type) %>%
  dplyr::summarise(total_cells = sum(cells), .groups = "drop")

knitr::kable(
  overall_cells_by_assay,
  caption = "Total cells by assay (pooled across categories and replicates)",
  digits = 0)
```

### Figure 1C

```{r figure, echo=F}
rna_color <- "#7483A1"
ms2_color <- "#8C857B"

summary_se2 <- summary_se %>%
  dplyr::mutate(
    ms2_status = factor(ms2_status, levels = c("0","1","2",">=3")),
    assay_type = factor(assay_type, levels = c("RNA","MS2")))

freq_by_rep_pts <- freq_by_rep %>%
  dplyr::mutate(
    ms2_status = factor(ms2_status, levels = c("0","1","2",">=3")),
    assay_type = factor(assay_type, levels = c("RNA","MS2")))

mw_labels <- mw_results %>%
  dplyr::mutate(
    label = dplyr::case_when(
      is.na(p_value)  ~ "NA",
      p_value < 0.001 ~ "***",
      p_value < 0.01  ~ "**",
      p_value < 0.05  ~ "*",
      TRUE            ~ "ns"))

sig_df <- summary_se2 %>%
  dplyr::distinct(ms2_status) %>%
  dplyr::mutate(x = as.numeric(ms2_status), y = 1.05) %>%
  dplyr::left_join(mw_labels %>% dplyr::select(ms2_status, label), by = "ms2_status")

pd <- ggplot2::position_dodge(width = 0.45)

ggplot2::ggplot(summary_se2, ggplot2::aes(x = ms2_status, y = mean_freq, fill = assay_type)) +
  ggplot2::geom_col(width = 0.85, position = pd) +
  ggplot2::geom_errorbar(
    ggplot2::aes(ymin = mean_freq - se_freq, ymax = mean_freq + se_freq),
    width = 0.18, position = pd, linewidth = 0.6, na.rm = TRUE) +
  ggplot2::geom_point(
    data = freq_by_rep_pts,
    ggplot2::aes(x = ms2_status, y = freq, fill = assay_type, group = assay_type),
    position = pd, shape = 21, size = 3, color = "black", stroke = 0.4, alpha = 0.9,
    show.legend = FALSE) +
  ggplot2::geom_segment(
    data = sig_df,
    ggplot2::aes(x = x - 0.45, xend = x + 0.45, y = y, yend = y),
    inherit.aes = FALSE, linewidth = 0.6) +
  ggplot2::geom_text(
    data = sig_df,
    ggplot2::aes(x = x, y = y + 0.03, label = label),
    inherit.aes = FALSE, size = 4) +
  ggplot2::scale_y_continuous(limits = c(0, 1.1), breaks = seq(0, 1, 0.1)) +
  ggplot2::scale_x_discrete(expand = ggplot2::expansion(mult = c(0.01, 0.01))) +
  ggplot2::scale_fill_manual(values = c("RNA" = rna_color, "MS2" = ms2_color)) +
  ggplot2::labs(x = "Number of RNA signals/cell", y = "Density", fill = NULL) +
  ggplot2::theme_classic(base_size = 14) +
  ggplot2::theme(
    panel.grid = element_blank(),
    panel.background = element_blank(),
    plot.background = element_blank(),
    axis.line = element_line(color = "black", linewidth = 0.6),
    axis.ticks = element_line(color = "black"),
    legend.position = "right",
    legend.direction = "vertical",
    legend.text = element_text(size = 12),
    axis.title.x = element_text(margin = margin(t = 8)),
    axis.title.y = element_text(margin = margin(r = 8)))
```
Session info
```{r sessionInfo, include=TRUE, echo=TRUE, results="markup"}
sessionInfo()
```